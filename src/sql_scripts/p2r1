select STUDENT_CONTACT_REF, CONTACT_FIRST_NAME, CONTACT_LAST_NAME, passed, allll
from
(
select GRADE_STUDENT_EPITA_EMAIL_REF, STUDENT_CONTACT_REF, STUDENT_POPULATION_PERIOD_REF, STUDENT_POPULATION_YEAR_REF, STUDENT_POPULATION_CODE_REF, CONTACT_FIRST_NAME, CONTACT_LAST_NAME, count(case when SUMM > 10 then 1 end) as passed, count(*) as allll from(
select *, summm/couuunt as summ
from
(
select GRADE_STUDENT_EPITA_EMAIL_REF, GRADE_COURSE_CODE_REF,cn.COURSE_NAME, sum(GRADE_SCORE) as summm, count(GRADE_SCORE) as couuunt,  from GRADES
join (select COURSE_CODE, COURSE_NAME  from COURSES) as cn where cn.COURSE_CODE  = GRADE_COURSE_CODE_REF
group by GRADE_COURSE_CODE_REF, GRADE_STUDENT_EPITA_EMAIL_REF
order by GRADE_STUDENT_EPITA_EMAIL_REF
)
join STUDENTS on GRADE_STUDENT_EPITA_EMAIL_REF = STUDENT_EPITA_EMAIL
join CONTACTS on STUDENT_CONTACT_REF = CONTACT_EMAIL
)
group by GRADE_STUDENT_EPITA_EMAIL_REF, STUDENT_CONTACT_REF, STUDENT_POPULATION_PERIOD_REF, STUDENT_POPULATION_YEAR_REF, STUDENT_POPULATION_CODE_REF, CONTACT_FIRST_NAME, CONTACT_LAST_NAME
)
where STUDENT_POPULATION_CODE_REF = '{course}' and STUDENT_POPULATION_YEAR_REF = {year} and STUDENT_POPULATION_PERIOD_REF = '{period}'
